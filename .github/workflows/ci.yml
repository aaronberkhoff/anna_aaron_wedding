name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # sqlx compile-time query checks use cached .sqlx/ metadata (no live DB needed in CI).
  SQLX_OFFLINE: "true"
  DATABASE_URL: "sqlite:///tmp/ci_wedding.db"

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Native build â€” server + shared crates.
  # The frontend crate MUST be excluded here: it requires wasm32-unknown-unknown
  # and wasm-bindgen will not compile for a native target.
  # ---------------------------------------------------------------------------
  ci:
    name: CI (native)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-native-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-native-

      - name: Check formatting
        run: cargo fmt --all -- --check

      # Clippy with -D warnings: any warning is a CI failure.
      # --exclude frontend: frontend requires wasm32, cannot run on native.
      - name: Clippy (native)
        run: >
          cargo clippy
          --workspace --exclude frontend
          --all-targets --all-features
          -- -D warnings

      # Tests: same exclusion as clippy.
      - name: Test (native)
        run: >
          cargo test
          --workspace --exclude frontend
          --all-features

  # ---------------------------------------------------------------------------
  # Job 2: WASM frontend check.
  # cargo check type-checks the frontend crate against wasm32-unknown-unknown
  # without producing a final binary (which would require Trunk + wasm-opt).
  # This is fast and sufficient to catch compile errors in CI.
  # Full Trunk builds only happen in the Dockerfile (deploy path).
  # ---------------------------------------------------------------------------
  check-frontend:
    name: Check frontend (wasm32)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust stable with wasm32 target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
          components: clippy

      - name: Cache cargo artifacts (WASM)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          # Separate cache key to avoid mixing native and WASM artifacts.
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-wasm-

      - name: cargo check frontend (wasm32)
        run: >
          cargo check
          -p frontend
          --target wasm32-unknown-unknown

      - name: Clippy frontend (wasm32)
        run: >
          cargo clippy
          -p frontend
          --target wasm32-unknown-unknown
          -- -D warnings
